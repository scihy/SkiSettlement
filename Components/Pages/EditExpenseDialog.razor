@rendermode InteractiveServer
@inject IExpenseService ExpenseService
@inject ICategoryService CategoryService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Edytuj koszt</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudTextField @bind-Value="_model.Description" Label="Opis" Variant="Variant.Outlined" />
            <div class="mud-input-control mud-input-outlined">
                <label class="mud-input-label">Kategoria</label>
                <select class="mud-input-slot mud-input-outlined" value="@(_model.CategoryId?.ToString() ?? "")" @onchange="OnCategoryChange" style="min-width: 100%; padding: 8px;">
                    <option value="">â€”</option>
                    @foreach (var c in _categories)
                    {
                        <option value="@c.Id">@c.Name</option>
                    }
                </select>
            </div>
            <MudNumericField @bind-Value="_model.Amount" Label="Kwota" Variant="Variant.Outlined" Min="0" Step="0.01m" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Anuluj</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save">Zapisz</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public Expense Expense { get; set; } = null!;

    [Parameter]
    public List<ExpenseCategory> Categories { get; set; } = new();

    private Expense _model = new();
    private List<ExpenseCategory> _categories = new();

    protected override void OnParametersSet()
    {
        _model = new Expense
        {
            Id = Expense.Id,
            TripId = Expense.TripId,
            Description = Expense.Description,
            Amount = Expense.Amount,
            CategoryId = Expense.CategoryId
        };
        _categories = Categories;
    }

    private void Cancel() => MudDialog.Cancel();

    private void OnCategoryChange(ChangeEventArgs e)
    {
        var s = e.Value?.ToString();
        _model.CategoryId = string.IsNullOrEmpty(s) ? null : int.TryParse(s, out var id) ? id : null;
    }

    private async Task Save()
    {
        if (string.IsNullOrWhiteSpace(_model.Description)) return;
        await ExpenseService.UpdateAsync(_model);
        MudDialog.Close(DialogResult.Ok(true));
    }
}
